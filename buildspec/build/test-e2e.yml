version: 0.2

env:
  variables:
    NODE_ENV: e2etest
  parameter-store:
    POSTGRES_USER: /bnd/e2e-test-db-user
    POSTGRES_PASSWORD: /bnd/e2e-test-db-password
    POSTGRES_DB: /bnd/e2e-test-db-name

phases:
  pre_build:
    commands:
      - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 636146736465.dkr.ecr.eu-west-1.amazonaws.com
      - echo POSTGRES_USER=${POSTGRES_USER}\\nPOSTGRES_PASSWORD=${POSTGRES_PASSWORD}\\nPOSTGRES_DB=${POSTGRES_DB} > .env

  install:
    runtime-versions:
      nodejs: 22
    commands:
      - echo "Downgrading npm to match node version..."
      - npm install -g npm@10
      - make install-for-e2e

  build:
    commands:
      - make test-e2e-inside-docker-prebuilt
